{% extends "base.html" %}

{% block content %}
<div class="habit-cards-container">
{% if habits %}
    {% for habit in habits %}
    <div class="habit-card" draggable="true" data-habit-id="{{ habit.habit_id }}">
        <div class="habit-header">
            <form method="POST" action="{{ url_for('toggle_habit', habit_id=habit.habit_id) }}" style="margin: 0;" onsubmit="return false;">
                <input type="checkbox"
                       class="habit-checkbox"
                       {% if habit.completed_today %}checked{% endif %}
                       onchange="toggleHabit({{ habit.habit_id }}, this)">
            </form>
            <a href="{{ url_for('habit_detail', habit_id=habit.habit_id) }}" class="habit-name">{{ habit.habit_name }}</a>
        </div>

        <div class="habit-body">
            <div class="habit-count-display">
                <div class="count-wrapper">
                    <span class="count-main">{{ habit.count }}</span>
                    <span class="count-suffix">/100</span>
                </div>
            </div>

            <div class="dot-grid">
                {% for day_completed in habit.history %}
                <div class="dot {% if day_completed %}filled{% endif %}"></div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <p>No habits yet!</p>
    </div>
{% endif %}
</div>

<a href="{{ url_for('add_habit') }}" class="btn add-habit-btn">+ Add a Habit</a>

<script>
function toggleHabit(habitId, checkbox) {
    fetch(`/toggle-habit/${habitId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        if (!response.ok) {
            // If the request failed, revert the checkbox
            checkbox.checked = !checkbox.checked;
            alert('Failed to update habit. Please try again.');
        } else {
            // Update the UI after successful toggle
            const habitCard = checkbox.closest('.habit-card');
            const countElement = habitCard.querySelector('.count-main');
            const dotGrid = habitCard.querySelector('.dot-grid');
            const firstDot = dotGrid.querySelector('.dot:first-child');

            // Update the count
            let currentCount = parseInt(countElement.textContent);
            if (checkbox.checked) {
                countElement.textContent = currentCount + 1;
                firstDot.classList.add('filled');
            } else {
                countElement.textContent = currentCount - 1;
                firstDot.classList.remove('filled');
            }
        }
    })
    .catch(error => {
        // If there's an error, revert the checkbox
        checkbox.checked = !checkbox.checked;
        alert('Failed to update habit. Please try again.');
    });
}

// Drag and drop functionality
let draggedElement = null;

document.addEventListener('DOMContentLoaded', function() {
    const habitCards = document.querySelectorAll('.habit-card');

    habitCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
    });
});

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    document.querySelector('.habit-cards-container').classList.add('is-dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';

    const container = document.querySelector('.habit-cards-container');
    const afterElement = getDragAfterElement(container, e.clientY);
    if (afterElement == null) {
        container.appendChild(draggedElement);
    } else {
        container.insertBefore(draggedElement, afterElement);
    }

    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    return false;
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelector('.habit-cards-container').classList.remove('is-dragging');

    // Get the new order of habit IDs
    const habitCards = document.querySelectorAll('.habit-card');
    const habitIds = Array.from(habitCards).map(card => card.dataset.habitId);

    // Save the new order to the backend
    fetch('/reorder-habits', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ habit_ids: habitIds })
    })
    .then(response => {
        if (!response.ok) {
            alert('Failed to save habit order. Please refresh the page.');
        }
    })
    .catch(error => {
        alert('Failed to save habit order. Please refresh the page.');
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.habit-card:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
</script>
{% endblock %}
